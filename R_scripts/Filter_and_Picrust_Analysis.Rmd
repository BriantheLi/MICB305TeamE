---
title: "Filtering and picrust out"
output: html_document
date: "2025-11-25"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r library loading}
library(tidyverse)
library(dplyr)
library(ggpicrust2)
library(DESeq2)
library(GGally)
library(phyloseq)
library(microbiome)
library(ggVennDiagram)
library(vegan)
```


```{r filtering and saving new filtered datsets}
# Alcohol dataset
alc_original = read.delim("../Datasets/p8_metadata.txt",  header = TRUE)
alc_no_species = alc_original %>%
  select(-Host)

alc_no_species$alcohol_intake_status = ifelse(
  (alc_no_species$host_sex == "female" & alc_no_species$GramPerday >= 25) |
    (alc_no_species$host_sex == "male" & alc_no_species$GramPerday >= 45),
  "High", "Low")

alc_no_species$age_group = ifelse(
  alc_no_species$Host_age >= 60, "Senior",
  ifelse(alc_no_species$Host_age >= 20 & alc_no_species$Host_age < 60, "Adult", "Child")
)
alc_grouped = alc_no_species
alc_removed_row_5 = alc_grouped[-5, ]
alc_removed_row_5$GramPerday = as.numeric(alc_removed_row_5$GramPerday)
alc_removed_row_5$Host_age = as.numeric(alc_removed_row_5$Host_age)
alc_fixed = alc_removed_row_5

alc = alc_fixed |>
  filter(alcohol_intake_status == 'Low')
# IBD dataset
ryan_ibd_data = read.delim('../Datasets/ryan_metadata.tsv', header = TRUE)
ryan_ibd_data_filtered = ryan_ibd_data |>
  filter(Smoking.status == 'Non-smoker') |>
  filter(Medications == 'No' | Medications == "") |>
  filter(Age_when_sampled != "Uncertain")

ryan_ibd_data_filtered$Medications = ifelse(
  ryan_ibd_data_filtered$Medications == "",  # test for empty string
  "No",                                       # value if TRUE
  ryan_ibd_data_filtered$Medications         # value if FALSE
)

# join the filtered datasets with the manifest datasets
# Alcohol
# Make sure both are data frames
alc_fixed = as.data.frame(alc_fixed)
p8_manifest = read.table("../Datasets/p8_manifest.tsv", header = TRUE, sep = "\t")
alc_merged_data = left_join(alc_fixed, p8_manifest)

# IBD
ryan_ibd_data_filtered = as.data.frame(ryan_ibd_data_filtered)
ryan_manifest = read.table("../Datasets/ryan_manifest.tsv", header = TRUE, sep = "\t")
ryan_ibd_merged_data = left_join(ryan_ibd_data_filtered, ryan_manifest)

# Combine both IBD conditions into IBD and leave in the same column Condition (Only IBD vs Healthy) for PICRUST only


# saving datasets into tsv format
# alcohol
write.table(
  alc_merged_data,                # your merged data frame
  file = "../Datasets/alc_merged_data.tsv",   # output file name
  sep = "\t",                 # tab-separated
  row.names = FALSE,          # don’t write row numbers
  quote = FALSE               # don’t quote strings unless needed
)
# IBD
write.table(
  ryan_ibd_merged_data,                # your merged data frame
  file = "../Datasets/ryan_ibd_merged_data.tsv",   # output file name
  sep = "\t",                 # tab-separated
  row.names = FALSE,          # don’t write row numbers
  quote = FALSE               # don’t quote strings unless needed
)
```

```{r pathways datasets loading}
pathways_alcohol = read.delim("../Datasets/p8alcohol_path_abun_unstrat.tsv", row.name = 1) # reading in the tsv with rownames as the first column

pathways_ibd = read.delim("../Datasets/ryan_path_abun_unstrat.tsv", row.name = 1) # reading in the tsv with rownames as the first column

```

```{r}
# Alcohol
alcohol_daa_results_df = pathway_daa(abundance = pathways_alcohol,
                              metadata = alc_merged_data,
                              group = "alcohol_intake_status",
                              daa_method = "DESeq2",
                              select = NULL, reference = NULL)

alcohol_daa_annotated_results_df = pathway_annotation(pathway = "MetaCyc",
                                               daa_results_df = alcohol_daa_results_df)

# IBD

# Merging IBD CD and UC Conditions
picrust_ibd_merged_data = ryan_ibd_merged_data %>% 
  mutate(Condition_merged = case_when(
    str_detect(Condition, "Healthy") ~ "Healthy",
    str_detect(Condition, "Crohn's Disease") ~ "IBD",
    str_detect(Condition, "Ulcerative Colitis") ~ "IBD"
  ))

ibd_daa_results_df = pathway_daa(abundance = pathways_ibd,
                              metadata = picrust_ibd_merged_data,
                              group = "Condition_merged",
                              daa_method = "DESeq2",
                              select = NULL, reference = NULL)

ibd_daa_annotated_results_df = pathway_annotation(pathway = "MetaCyc",
                                               daa_results_df = ibd_daa_results_df)
```

```{r plotting}
source('ggpicrust2_errorbar_function_fixed.R')


alcohol_daa_annotated_results_df %>% filter(p_adjust < 0.05) %>% nrow()

# Explain this!
# This makes sense, as there are no significant differences between different alcohol inflammatory environments' high level pathways 
```

```{r plotting}
# Figure 3 Using the special dataset
source('ggpicrust2_errorbar_function_fixed.R')

ibd_daa_annotated_results_df %>% filter(p_adjust < 0.05) %>% nrow()

ibd_peb = pathway_errorbar_fixed(abundance = pathways_ibd, 
                     daa_results_df = ibd_daa_annotated_results_df,
                     Group = picrust_ibd_merged_data$Condition_merged,
                     wrap_label = T, wraplength=60,
                     fc_cutoff = 0.2, order_by_log = F,
                     p_values_threshold = 0.05, # Changed the p value threshold to include at least 2 results
                     ko_to_kegg = FALSE, 
                     p_value_bar = TRUE, 
                     x_lab = "description")

ibd_peb
```

```{r core microbiome}
# Using the uncombined IBD dataset
# Loading datasets
alcohol_taxonomy = read.delim('../Datasets/p8alcohol_taxonomy.tsv', row.names = 1)
alcohol_counts = read.delim('../Datasets/p8alcohol_feature-table.txt', skip=1, row.names=1)
alc_metadata = read.delim("../Datasets/alc_merged_data.tsv", row.names = 1)

ibd_taxonomy = read.delim('../Datasets/ryan_taxonomy.tsv', row.names = 1) 
ibd_counts = read.delim('../Datasets/ryan_feature-table.txt', skip=1, row.names=1)
ibd_metadata = read.delim("../Datasets/ryan_ibd_merged_data.tsv", row.names = 1)

# Figure 2
# Alcohol

# counts datatset
alcohol_counts = as.matrix(alcohol_counts)
alc_counts = otu_table(alcohol_counts, taxa_are_rows = T)

# metadata
alc_sam_data = sample_data(alc_metadata)

# taxanomy dataset
alc_tax_wrangled = alcohol_taxonomy |>
  separate(col = Taxon, 
           into = c('Domain','Phylum','Class','Order',
                    'Family','Genus','Species'),
           sep=';', fill='right') |>
           select(-Confidence) |>
           as.matrix()
alc_tax_wrangled = tax_table(alc_tax_wrangled)

# combine
alc_ps = phyloseq(alc_counts, alc_sam_data, alc_tax_wrangled)

# print out the ps
alc_ps


# IBD

# counts datatset
ibd_counts = as.matrix(ibd_counts)
ibd_counts = otu_table(ibd_counts, taxa_are_rows = T)

# metadata
ibd_sam_data = sample_data(ibd_metadata)

# taxanomy dataset
ibd_tax_wrangled = ibd_taxonomy |>
  separate(col = Taxon, 
           into = c('Domain','Phylum','Class','Order',
                    'Family','Genus','Species'),
           sep=';', fill='right') |>
           select(-Confidence) |>
           as.matrix()
ibd_tax_wrangled = tax_table(ibd_tax_wrangled)

# combine
ibd_ps = phyloseq(ibd_counts, ibd_sam_data, ibd_tax_wrangled)

# print out the ps
ibd_ps

# Core microbiome plots

# Alcohol

# Rarefy if desired and convert to relative abundance, use tax_glom (optional)
alc_psrare = rarefy_even_depth(alc_ps, sample.size = 51)
alc_ps_rare_relab = transform(alc_psrare, 'compositional')
alc_ps_rare_relab_genus = tax_glom(alc_ps_rare_relab, 'Genus')

# Subset your phyloseq object
low_alcohol_intake = subset_samples(alc_ps_rare_relab_genus, alcohol_intake_status == 'Low')
high_alcohol_intake = subset_samples(alc_ps_rare_relab_genus, alcohol_intake_status == 'High')

# Find core members
ASVs_low_alcohol_intake = core_members(low_alcohol_intake, detection=0.001, prevalence = 0.8)
ASVs_high_alcohol_intake = core_members(high_alcohol_intake, detection=0.001, prevalence = 0.8)

ggVennDiagram(list(ASVs_low_alcohol_intake, ASVs_high_alcohol_intake),
      			  set_size = 3,
              category.names = c('low_alcohol_intake','high_alcohol_intake'))

# Need to save this in the Figures folder inside of the Results folder

# IBD

# Rarefy if desired and convert to relative abundance, use tax_glom (optional)
ibd_psrare = rarefy_even_depth(ibd_ps, sample.size = 120)
ibd_ps_rare_relab = transform(ibd_psrare, 'compositional')
ibd_ps_rare_relab_genus = tax_glom(ibd_ps_rare_relab, 'Genus')

# Subset your phyloseq object
healthy = subset_samples(ibd_ps_rare_relab_genus, Condition == 'Healthy')
crohn_disease = subset_samples(ibd_ps_rare_relab_genus, Condition == "Crohn's Disease")
ulcerative_colitis = subset_samples(ibd_ps_rare_relab_genus, Condition == "Ulcerative Colitis")

# Find core members
ASVs_healthy = core_members(healthy, detection=0.001, prevalence = 0.8)
ASVs_crohn_disease = core_members(crohn_disease, detection=0.001, prevalence = 0.8)
ASVs_ulcerative_colitis = core_members(ulcerative_colitis, detection=0.001, prevalence = 0.8)

ggVennDiagram(list(ASVs_healthy, ASVs_crohn_disease, ASVs_ulcerative_colitis),
      			  set_size = 3,
              category.names = c('Healthy',"Cronh's Disease", "Ulcerative Colitis"))
# Need to save this in the Figures folder inside of the Results folder

# Combine both core microbiome
ggVennDiagram(list(ASVs_healthy, ASVs_crohn_disease, ASVs_ulcerative_colitis, ASVs_low_alcohol_intake, ASVs_high_alcohol_intake),
      			  set_size = 2,
              category.names = c('Healthy',"CD", "UC", 'low_alcohol_intake','high_alcohol_intake')) +
              theme(text = element_text(size = 18))
# Maybe save this in the Figures folder inside of the Results folder

```

```{r Alpha diversity plot}
# Using the uncombined IBD dataset
# Figure 1
# Alcohol
rarecurve(t(data.frame(alc_ps@otu_table)),
          step = 1000)

alc_psrare = alc_ps %>% rarefy_even_depth(sample.size = 51, rngseed = 5362)

table(sample_sums(alc_psrare))

set.seed(5362)
alc_p = plot_richness(alc_psrare, x = 'alcohol_intake_status', 
                  measures = c('Shannon'),
                  color = 'alcohol_intake_status')
alc_p

# Extract the data from p
set.seed(5362)
alc_p_data = alc_p$data

alc_p_formatted = alc_p_data %>% ggplot(aes(alcohol_intake_status,value,fill = alcohol_intake_status)) +
  
  # Don't plot outlier points - we're plotting all points below.
  geom_boxplot(outlier.shape = NA) + 
  
  # Now we can space the points out sideways, reducing overlap.
  geom_jitter(height=0,width=0.2) +
  
  # Add some formatting
  theme_classic(base_size=13) +
  facet_wrap(~variable,ncol=4,scales = 'free_y') +
  ylab('Alpha Diversity') + xlab(NULL) +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1)) +
  labs(fill='alchol intake status')
alc_p_formatted

# Wilcoxon test
comparisons = list(c("Low","High"))

# Oftentimes the p values get cut off at the top - just expand the axis by a fraction
alcohol_shannon_diversity_plot = alc_p_formatted +
  stat_compare_means(comparisons = comparisons, method='wilcox.test', size=5) +
  scale_y_continuous(expand = expansion(mult = c(0, .1))) # c(bottom, top)
alcohol_shannon_diversity_plot

# saving the figure
# ggsave('../Results/Figures - Shannon Alpha Diversity Plot.jpeg',
#        plot = shannon_diversity_plot, # by defult, ggsave will save the last plot
#        height=7, width = 14) # units are inches by default

# IBD 
rarecurve(t(data.frame(ibd_ps@otu_table)),
          step = 1000)

ibd_psrare = ibd_ps %>% rarefy_even_depth(sample.size = 120, rngseed = 5362)

table(sample_sums(ibd_psrare))

set.seed(5362)
ibd_p = plot_richness(ibd_psrare, x = 'Condition', 
                  measures = c('Shannon'),
                  color = 'Condition')
ibd_p

# Extract the data from p
set.seed(5362)
ibd_p_data = ibd_p$data

ibd_p_formatted = ibd_p_data %>% ggplot(aes(Condition,value,fill = Condition)) +
  
  # Don't plot outlier points - we're plotting all points below.
  geom_boxplot(outlier.shape = NA) + 
  
  # Now we can space the points out sideways, reducing overlap.
  geom_jitter(height=0,width=0.2) +
  
  # Add some formatting
  theme_classic(base_size=13) +
  facet_wrap(~variable,ncol=4,scales = 'free_y') +
  ylab('Alpha Diversity') + xlab(NULL) +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1)) +
  labs(fill='Condition')
ibd_p_formatted

# Wilcoxon test
comparisons = list(c("Healthy","Crohn's Disease", "Ulcerative Colitis"))

# Oftentimes the p values get cut off at the top - just expand the axis by a fraction
ibd_shannon_diversity_plot = ibd_p_formatted +
  stat_compare_means(comparisons = comparisons, method='wilcox.test', size=5) +
  scale_y_continuous(expand = expansion(mult = c(0, .1))) # c(bottom, top)
ibd_shannon_diversity_plot

# saving the figure
# ggsave('../Results/Figures - Shannon Alpha Diversity Plot.jpeg',
#        plot = shannon_diversity_plot, # by defult, ggsave will save the last plot
#        height=7, width = 14) # units are inches by default

```

```{r Beta }
# Using the uncombined IBD dataset
# Figure 1
# Alcohol


# IBD

```

